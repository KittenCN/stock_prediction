# 股票预测模型策略蓝图（零基重构）

> 目标：摆脱现有实现包袱，从数据出发重新设计股票价格预测算法体系，明确候选方案的结构与优缺点，并给出推荐组合。

---

## 1. 数据与任务基线

### 1.1 数据来源
- **行情字段**：开盘价、收盘价、最高价、最低价、成交量、成交额、换手率等（`init.py` 中的 `name_list`）。
- **技术指标**：MACD、KDJ、BOLL、CCI、DMI、TRIX、ATR、TAQ 等，通过 `common.add_target()` 动态生成。
- **数据形态**：按股票代码划分的日频时间序列，常以滑动窗口（`SEQ_LEN=5` 可调整）构造输入，输出为未来价格、收益或趋势。
- **特性**：高噪声、非平稳，极端事件频繁；当前流程以单标的为主，后续可扩展至多标的联动。

### 1.2 任务约束
- **目标类型**：点预测、分位区间预测或趋势分类。
- **时间粒度**：日频，需兼顾短期波动与中期趋势。
- **部署限制**：PyTorch 实现，兼容 CPU/GPU，保证可复现。
- **评估指标**：RMSE、MAE、分位覆盖率、方向准确率，可补充收益相关指标（加权 RMSE、Calmar 比率、VaR、CVaR）。

---

## 2. 候选模型方案

### 2.1 ProbTemporalFusionTransformer (PTFT)
- **核心**：基于 Temporal Fusion Transformer，加入变量选择网络、多尺度位置编码、门控残差。
- **输出**：除了点预测，还能生成多个分位值或分布参数，实现概率预测。
- **训练**：分位损失 (pinball) 或 CRPS；可叠加 RMSE/MAPE 与变量选择 L1 正则。
- **优点**：解释性强、原生支持多步预测，适合风险评估。
- **缺点**：结构复杂，对数据规模与算力要求较高；多模态特征需额外编码。

### 2.2 Variational State Space Model (V-SSM)
- **核心**：引入隐藏市场状态，利用变分推断学习状态转移与观测方程。
- **增强**：使用 GRUCell 构建时间依赖先验，输出状态概率并支持 Regime 分析。
- **训练**：最大化 ELBO，引入 KL Annealing/Free Bits，必要时结合对比学习。
- **优点**：兼顾可解释性与鲁棒性，可输出 regime 概率辅助风险控制。
- **缺点**：实现复杂，需仔细调参；Regime 数量与外生变量需要经验设定。

### 2.3 Diffusion Forecaster（扩散式生成）
- **核心**：借鉴 TimeGrad / DiffWave，通过扩散模型学习未来路径分布。
- **特点**：擅长建模多峰分布，可生成多条情景路径，适用于 VaR/CVaR 分析。
- **限制**：训练与采样成本高，对数据规模敏感，解释性偏弱。

### 2.4 Graph Temporal Fusion (GTSF)
- **核心**：构建多股票图结构，结合 GNN 与时间模型捕捉跨标的影响。
- **适用**：多资产扩展场景，目前流程可作为预研储备。
- **挑战**：需要额外数据准备及图构建策略。

---

## 3. 推荐组合

### 3.1 主推：PTFT + V-SSM 双轨融合
- **思路**：PTFT 输出高精度、多分位预测；V-SSM 提供市场状态概率，两者融合后调整预测区间。
- **实现提示**：代码位于 `src/stock_prediction/models/ptft.py`、`vssm.py`、`ptft_vssm.py`；CLI 新增 `--model ptft_vssm`，损失函数 `PTFTVSSMLoss` 自动叠加 KL 正则。
- **实施步骤**：
  1. 特征工程：通过 `feature_engineering.py` 生成对数收益率/差分特征，按配置合并外生变量，并对多股票样本进行滑动窗口聚合。
  2. 模型训练：分别训练 PTFT 与 V-SSM，关注 RMSE、分位损失、regime 分类准确率等指标。
  3. 融合校准：采用 Regime 感知 Soft Gating（Bayesian Dropout 支持）实现 PTFT/VSSM 自适应权重，记录融合权重解释指标。
  4. 金融指标：在 `PTFTVSSMLoss` 中叠加方向性、Sharpe、最大回撤等约束，充分利用分位输出。
  5. 推理部署：实时输入历史窗口 → 特征工程模块对齐外生变量 → PTFT 输出分布参数 → V-SSM 给出状态概率 → 融合层产出最终预测与风险提示。

### 3.2 备用：PTFT + Diffusion
- 在数据充足且需要情景模拟时引入扩散模型；使用 PTFT 分布先验可加速训练收敛。

### 3.3 不推荐
- 单一 CNN/RNN：缺乏多尺度与概率建模能力，易过拟合。
- 传统机器学习（XGBoost/RandomForest）：难以覆盖序列依赖与多步预测需求。

---

## 4. 实施路线图
| 阶段 | 目标 | 关键任务 | 输出 |
| ---- | ---- | -------- | ---- |
| Phase 0 | 数据校验与配置梳理 | 检查异常值、缺失值，统一配置模板 | 数据质量报告、特征字典 |
| Phase 1 | PTFT 实现 | Variable Selection、GRN、Decoder、分位输出 | PTFT 代码与调参日志 |
| Phase 2 | V-SSM 实现 | 时间依赖先验、变分推断与 regime 解析 | V-SSM 代码与状态分析报告 |
| Phase 3 | 融合校准 | 设计线性组合/校准层/学习式融合策略 | 联合评估报告、融合脚本 |
| Phase 4 | 训练 & 部署自动化 | 训练脚本、推理 CLI/API、监控指标 | 流水线与监控方案 |

---

## 5. 风险与缓解
| 风险 | 描述 | 缓解措施 |
| ---- | ---- | -------- |
| 数据质量 | 指标缺失或异常影响模型收敛 | Phase 0 加强校验，缺失值回填或剔除 |
| 模型过拟合 | PTFT 参数量大 | 使用正则、Dropout、早停、交叉验证 |
| 状态解释困难 | V-SSM 状态与真实市场不匹配 | 利用 SHAP/PCA、指标对比等后验工具；必要时加入监督信号 |
| 推理性能 | 双轨模型延迟较高 | 知识蒸馏、异步推理、轻量化版本 |
| 维护成本 | 模型组合复杂 | 规范配置、统一训练管线、完善文档 |

---

## 6. 后续工作指引
1. **配置体系**：引入 YAML/JSON 配置与 `pydantic` 校验，统一管理模型超参。
2. **训练脚本**：编写 `train_ptft.py`、`train_vssm.py`、`evaluate_combo.py`，形成自动化流程。
3. **监控指标**：记录 RMSE、MAPE、分位覆盖率、VaR/CVaR 等指标，并接入报警系统。
4. **文档维护**：实现与实验完成后更新 `docs/maintenance.md`、`docs/system_design.md`，并在此补充结论。
5. **扩展方向**：探索扩散模型用于情景分析，或构建图结构以支持多资产预测。
   - 扩散与图建模预研计划参见 `docs/research_diffusion_graph.md`，包含实验步骤与阶段目标；仓库内首版实现可通过 `--model diffusion` 与 `--model graph` 调用。
   - Hybrid 2.0 总线化设计详见 `docs/hybrid_rearchitecture.md`，Hybrid 使用 `HybridLoss` 组合损失支撑多分支融合。
   - 针对“均线吸附”问题的优化计划：相对归一、股票 ID 嵌入、损失约束、层次化模型与分组蒸馏，详见 `docs/maintenance.md`。

### 6.1 PTFT+VSSM 改进路线（新增）
| 优先级 | 状态 | 改进方向 | 关键动作 | 预期收益 |
| ------ | ---- | -------- | -------- | -------- |
| 高 | ✅ | **收益率序列建模** | 在 `feature_engineering.py` 中生成对数收益率/标准化差分，训练时允许选择收益率目标；同步新增回测基准 | 缓解价格序列非平稳性，提升趋势感知 |
| 高 | ✅ | **Regime 感知融合** | 设计基于 VSSM regime 置信度的动态加权（soft gating），并提供启发式/学习式两套方案 | 让集成在不同市场状态下自适应调整 |
| 中 | ✅ | **模型瘦身与正则** | 调整 `hidden_dim/state_dim` 规模，引入贝叶斯 Dropout / L2；补充 regime 辅助分类损失 | 降低过拟合风险，保持解释性 |
| 中 | ✅ | **特征与数据扩充** | 引入宏观、行业、舆情等外生变量；尝试多股票联合训练与滑动窗口集成 | 拓宽数据覆盖面，提高泛化能力 |
| 中 | ✅ | **金融指标导向训练** | 在损失中叠加方向性惩罚，探索夏普/最大回撤等金融指标的代理目标；充分利用分位输出 | 让预测结果更贴合交易/风控需求 |

> 详见 `docs/ptft_vssm_analysis_20251015.md`，用于指导 Phase 3 之后的模型演进与实验设计。

---
本蓝图与 `docs/system_design.md`、`docs/maintenance.md` 配套使用，确保设计方案与实现状态保持同步。 

## 股票 ID 嵌入策略进展（2025-10-17 · 已完成）
- 已落地 ts_code 嵌入：特征工程产出 `_symbol_index`，Hybrid/PTFT/Diffusion/Graph 模型复用统一嵌入表。
- 嵌入维度由配置 `features.symbol_embedding_dim` 控制，默认 16，可按模型容量调整。
- 训练/推理脚本自动传递符号张量，兼容旧模型，不启用嵌入时无性能影响。

## 损失函数强化策略（2025-10-20 · 已完成）
- HybridLoss 与 PTFTVSSMLoss 已加入波动度/极值约束，训练阶段可通过权重参数调优，缓解预测均值吸附。
- 建议结合验证集对 olatility_weight、extreme_weight 进行网格搜索，并关注 Sharpe/最大回撤的配套指标。

## 扩散与图模型迭代（2025-10-20 · 已完成首轮）
- 扩散/图模型迭代：`DiffusionForecaster` 已支持 `cosine` 调度与上下文条件输入；`GraphTemporalModel` 支持动态邻接混合，可与股票嵌入共用。
- 下一步：研究可学习噪声调度、动态构图策略以及与 Hybrid 总线的融合。

- Hybrid 分支门控：TemporalHybridNet 支持先验权重与软门控，可配合阶段式训练与蒸馏策略。
