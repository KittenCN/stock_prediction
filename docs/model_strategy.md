# 股票价格预测模型策略蓝图（零基重构）  

> 目标：不依赖现有仓库中的 LSTM/TCN/Transformer 等实现，从数据出发重新设计面向股票价格预测的算法体系，明确候选方案、优劣分析与推荐组合，为后续研发提供直接依据。  

---

## 1. 数据与任务基线  

### 1.1 数据来源与结构  
- **行情字段**：开盘价、收盘价、最高价、最低价、成交量、成交额、换手率等（`init.py` → `name_list` + `add_target` 扩展）。  
- **技术衍生指标**：MACD、KDJ、BOLL、CCI、DMI、TRIX、ATR、TAQ 等，以单支股票日频序列为主。  
- **数据形态**：按股票代码划分的时间序列，训练阶段通常以滚动窗口（长度 `SEQ_LEN=5` 可调整）构造输入，输出为未来 N 日价格或收益序列。  
- **噪声特性**：高噪声、非平稳、极端事件频繁；不同股票之间存在行业关联但当前数据处理流程主要聚焦单标的。  

### 1.2 预测目标与约束  
- **主目标**：预测未来价格（点预测 / 区间预测 / 趋势分类三种可能式）。  
- **时间粒度**：日频，需兼顾短期波动与中期趋势。  
- **部署限制**：以 Python + PyTorch 为主，可扩展至 GPU，但需保证 CPU 可运行。  
- **评估指标**：RMSE/MAE（点预测）、覆盖率/宽度（区间预测）、方向准确率（趋势分类）。建议引入加权指标：如收益相关的加权 RMSE、Calmar 比率等。  

### 1.3 非功能约束  
- **可扩展性**：后续可能合并多标的与多数据源（宏观、舆情、行业指数）。  
- **可解释性**：金融场景需要洞察贡献因子与风险来源。  
- **执行效率**：应支持批量训练与在线/离线推理，避免过长的回溯窗口导致显存爆炸。  

---

## 2. 候选方案设计  

### 2.1 方案 A：概率时序融合 Transformer（PTFT）  
**核心思想**  
- 基于 Temporal Fusion Transformer（TFT）的改造版，对输入特征进行可学习的变量选择（Variable Selection Network），同时结合多尺度位置编码与门控残差。  
- 输出不仅提供点预测，还直接生成正态/混合高斯分布参数，支持区间预测与风险度量。  

**网络结构**  
1. **静态 & 动态嵌入**：将股票 ID、行业等静态特征与技术指标、价格序列分开编码；引入自适应变量选择权重。  
2. **多尺度时间编码**：结合日、周、月周期性编码，缓解固定窗口导致的长周期信息缺失。  
3. **门控注意力块**：采用门控残差（GLU）与多头注意力提取依赖；Decoder 端加入前瞻注意力处理多步预测。  
4. **分位数/分布输出头**：通过多头线性层输出分位点或分布参数，实现概率预测。  

**训练策略**  
- 损失函数：分位数损失 (pinball) 或 CRPS；可以叠加 MAPE / RMSE 作为辅助。  
- 正则化：变量选择权重的 L1 正则、Dropout、早停。  

**优点**  
- 强解释性：变量选择网络 + 注意力权重可追溯重要特征与时间片。  
- 适配多步预测：Decoder 结构天然支持 rolling 输出。  
- 支持概率预测：利于风险管理与策略评估。  

**缺点**  
- 模型复杂，参数量大，对训练数据规模与算力要求较高。  
- 多模态输入（如舆情）需额外编码模块。  

### 2.2 方案 B：变分状态空间模型（V-SSM）  
**核心思想**  
- 将股票价格视作由隐藏市场状态驱动的观测变量，使用变分推断学习状态转移与观测方程。  
- 通过 Regime-Switching（多状态）捕捉牛熊/震荡等市场形态，结合外生因子。  

**模型结构**  
1. **状态转移**：使用 GRU / MLP 参数化的高斯转移模型 `p(z_t | z_{t-1}, u_t)`，其中 `u_t` 为可选外生变量（如宏观指标）。  
2. **观测模型**：价格收益 `y_t` 条件于状态 `z_t` 的高斯或 Student-t 分布。  
3. **推断网络**：变分编码器 `q(z_t | z_{t-1}, y_{t:t+k})`，使用 RNN/Transformer 滤波与平滑。  
4. **Regime 混合**：通过门控或 Gumbel-Softmax 引入离散市场状态。  

**训练策略**  
- 最大化 ELBO，加入 KL Annealing、Free Bits 防止 posterior collapse。  
- 可结合对比学习，增强不同状态的区分度。  

**优点**  
- 兼具可解释性（隐藏状态对应市场 regime）与预测能力。  
- 对极端事件具备更高鲁棒性，可输出状态概率供策略决策。  

**缺点**  
- 实现复杂，训练需 carefully tuning；推断阶段的数值稳定性需重点关注。  
- 仍需手动选择外生变量与 Regime 数量。  

### 2.3 方案 C：扩散式时序生成模型（Diffusion Forecaster）  
**核心思想**  
- 借鉴 TimeGrad / DiffWave，将价格序列建模为随机过程，通过扩散模型学习潜在噪声分布，再用反向过程生成未来路径。  

**结构要点**  
1. **Noise Schedule**：对目标窗口 `y_{t+1:t+H}` 逐步添加噪声，学习 denoising 网络。  
2. **条件编码**：历史窗口、技术指标作为条件输入，使用 Transformer 或 TCN 编码器。  
3. **采样策略**：多次采样得到不同未来路径，供风险评估与策略蒙特卡洛。  

**优点**  
- 擅长建模多峰分布，适合处理市场的多种可能演化。  
- 可直接输出多条未来路径，便于 VaR/CVaR 计算。  

**缺点**  
- 训练代价高，采样耗时；需大量数据支撑。  
- 解释性弱，适合与其他模型组合使用。  

### 2.4 方案 D：图时序融合（GTSF）  
**核心思想**  
- 将不同股票或行业指数构建成图结构，结合 GNN + 时间模型捕捉跨标的关系。  
- 适用于扩展到多股票的情境；当前单股票场景可作为预研储备。  

**结构要点**  
1. **图构建**：基于行业、相关性（皮尔逊/互信息）、市值等构建邻接矩阵。  
2. **图编码器**：Graph Attention Network / ChebNet 与时间编码器（Transformer/LSTM）串联。  
3. **多任务输出**：同时预测自身价格、行业指数或风险指标。  

**优点**  
- 能显式建模跨资产影响，便于扩展到多标的策略。  

**缺点**  
- 需要额外数据支撑与图构建；当前数据管线需显著扩展。  

---

## 3. 推荐方案与组合  

### 3.1 主推方案：PTFT + V-SSM 双轨组合  
**组合思路**  
- **PTFT** 提供高精度、可解释的点预测与分位区间。  
- **V-SSM** 输出市场状态概率与风险评估，辅助调整 PTFT 的输出（如在高波动状态下收紧预测区间）。  
- 推理阶段：PTFT 生成主预测，V-SSM 提供 regime 权重与置信约束，两者通过加权或校准层融合。  

**适用场景**  
- 单股票或小规模组合的中短期价格预测，需要概率输出与风险标定。  

**关键实现步骤**  
1. **特征管线重构**：  
   - 将原始技术指标按类别（价格类 / 波动类 / 成交量类）分组，构建变量选择模块输入。  
   - 若可引入宏观或外生因素，作为 V-SSM 的外生变量 `u_t`。  
2. **模型实现**：  
   - 基于 PyTorch 实现可配置的 PTFT（含 Variable Selection、Static Covariate Encoder、Gated Residual Network、Decoder）。  
   - 构建 V-SSM：基于 GRU 的状态转移、线性/MLP 观测层、变分编码器。  
3. **训练策略**：  
   - 先独立训练 PTFT 与 V-SSM；验证指标包含 RMSE、分位损失、Regime 分类准确率等。  
   - 训练完毕后，可在验证集中拟合一个简单的校准模块（如线性组合、Gradient Boosting）整合两者输出产生最终预测。  
4. **推理与部署**：  
   - 实时输入历史窗口 → PTFT 输出分布参数；V-SSM 产出状态概率。  
   - 通过状态概率调整分布（例如在高风险状态下注入更高噪声或调节方差）。  

### 3.2 备用方案：PTFT + Diffusion  
- 在数据规模允许、需要生成多条未来路径时，额外训练扩散模型用于情景模拟。  
- 通过 PTFT 的分布先验初始化扩散模型条件，提升收敛速度。  

### 3.3 回避方案  
- 纯 CNN/RNN 类单分支模型：解释性与多尺度能力不足，且容易过拟合。  
- 单一的传统机器学习（XGBoost/RandomForest）：难以捕捉长序列依赖与多步预测需求。  

---

## 4. 实施路线图  

| 阶段 | 目标 | 关键任务 | 输出 |
| ---- | ---- | -------- | ---- |
| Phase 0 | 数据梳理与验证 | 定义训练/验证/测试切分；确保指标质量、填补缺失值 | 特征字典、数据质量报告 |
| Phase 1 | PTFT 实现 | 构建变量选择 → 编码器 → Decoder → 分位输出；训练与调参 | PTFT 模型代码、权重、指标 |
| Phase 2 | V-SSM 实现 | 定义状态维度、变分推断结构；完成训练与状态解释 | V-SSM 模型代码、状态诊断报告 |
| Phase 3 | 模型融合 | 设计预测合成策略（线性组合 / 校准层 / 学习式融合） | 联合评估报告、融合脚本 |
| Phase 4 | 扩展与部署 | 训练自动化脚本、推理 API / CLI、监控指标 | 部署方案、监控计划 |

---

## 5. 风险与缓解  

| 风险 | 描述 | 缓解措施 |
| ---- | ---- | -------- |
| 数据不足或质量问题 | 特征缺失、指标加载失败会严重影响 PTFT 训练 | Phase 0 增加数据校验；缺失数据采用回填或剔除策略 |
| 模型过拟合 | PTFT 参数量大，训练集有限 | 交叉验证、正则化、早停、Dropout、变量选择稀疏化 |
| 状态解释不明确 | V-SSM 学出的状态与实际市场 regime 对不上 | 使用事后分析工具（SHAP、PCA、指标对比）解释状态；引入监督信号 |
| 推理性能 | PTFT 与 V-SSM 同时运行可能增加延迟 | 将推理拆分为异步流程，或部署轻量化版本（知识蒸馏） |
| 维护成本 | 模型组合复杂 | 规范化配置管理、统一训练管线、完善文档（本文档+后续实现文档） |

---

## 6. 后续工作指引  

1. **配置模板**：更新 `config` 模块，引入 YAML/JSON 配置文件，支持切换 PTFT/V-SSM 超参。  
2. **训练脚本**：编写独立的 `train_ptft.py`、`train_vssm.py`、`evaluate_combo.py`，形成自动化流程。  
3. **监控指标**：设计模型输出监控（RMSE, MAPE, Directional Accuracy, Coverage Rate）与风险指标（VaR, Expected Shortfall）。  
4. **文档维护**：后续开发完成后更新 `README`、`docs/maintenance.md`，并在此文档追加实现细节与实验记录。  
5. **迭代方向**：探究将 Diffusion 模型接入情景分析；扩展 GTSF 以支持多资产预测。  

---

> 本文档为后续开发的设计蓝图，后续代码实现、实验日志、评估报告应逐步补充至 `docs/maintenance.md` / `docs/system_design.md` 并与本文互相引用。mouse
